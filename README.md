# Qwen Car Agent ğŸš—

åŸºäºé˜¿é‡Œäº‘é€šä¹‰åƒé—® (Qwen-Max) çš„æ™ºèƒ½è½¦è½½è¯­éŸ³åŠ©æ‰‹ç³»ç»Ÿï¼Œæ”¯æŒè½¦è¾†æ§åˆ¶ã€å¯¼èˆªå’Œåª’ä½“æ’­æ”¾ç­‰åŠŸèƒ½ï¼Œé…å¤‡åŒå±å·¥ä½œå°ç”¨äºè°ƒè¯•æ€ç»´é“¾ã€‚

## æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯ |
|------|------|
| **åç«¯ API** | FastAPI + Uvicorn |
| **LLM** | é˜¿é‡Œäº‘ DashScope (Qwen-Max) |
| **æ•°æ®åº“** | SQLite + SQLAlchemy |
| **å‰ç«¯** | React 19 + TypeScript + Vite |
| **UI ç»„ä»¶** | Ant Design 6.x |
| **æ•°æ®é¢„å¤„ç†** | Pandas + openpyxl |

## æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     HTTP API     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     DashScope     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  React Frontend â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚  FastAPI Server â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚  Qwen-Max   â”‚
â”‚  (localhost:5173)â”‚                 â”‚  (localhost:8000)â”‚                   â”‚    LLM      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â–¼
                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                     â”‚  SQLite + JSON  â”‚
                                     â”‚  (æ—¥å¿— + çŸ¥è¯†åº“)  â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ•°æ®æµ

```mermaid
sequenceDiagram
    participant U as ğŸ‘¤ ç”¨æˆ·
    participant F as ğŸ–¥ï¸ Frontend
    participant B as âš™ï¸ Backend
    participant Q as ğŸ¤– Qwen-Max
    participant D as ğŸ’¾ SQLite

    U->>F: è¾“å…¥æŒ‡ä»¤ "æ‰“å¼€ç©ºè°ƒ"
    F->>B: POST /chat
    B->>B: æ„å»º System Prompt (æ³¨å…¥çŸ¥è¯†åº“)
    B->>Q: è°ƒç”¨ LLM API
    Q-->>B: JSON å“åº” {action, reply, intent}
    B->>D: è®°å½•æ—¥å¿— (ChatLog)
    B-->>F: è¿”å›ç»“æœ + Trace ä¿¡æ¯
    F-->>U: æ˜¾ç¤ºå›å¤ + åŠ¨ä½œæ ‡ç­¾
```

## é¡¹ç›®ç»“æ„

```
car_bot/
â”œâ”€â”€ scripts/                    # æ•°æ®é¢„å¤„ç†
â”‚   â””â”€â”€ preprocess.py           # Excel â†’ JSON è½¬æ¢
â”œâ”€â”€ server/                     # FastAPI åç«¯
â”‚   â”œâ”€â”€ main.py                 # API è·¯ç”±å®šä¹‰
â”‚   â”œâ”€â”€ agent.py                # Qwen Agent æ ¸å¿ƒé€»è¾‘
â”‚   â”œâ”€â”€ database.py             # SQLite æ—¥å¿—è¡¨å®šä¹‰
â”‚   â””â”€â”€ data/
â”‚       â””â”€â”€ knowledge_base.json # çŸ¥è¯†åº“ (è§„åˆ™ + æ„å›¾)
â”œâ”€â”€ client/                     # React å‰ç«¯ (Vite + AntD)
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ App.tsx             # ä¸»åº”ç”¨ç»„ä»¶
â”‚       â””â”€â”€ index.css           # æ ·å¼æ–‡ä»¶
â”œâ”€â”€ VR_Feature_List_demo.xlsx   # åŸå§‹æ•°æ®æº
â””â”€â”€ car_bot.db                  # SQLite æ—¥å¿—æ•°æ®åº“
```

## ç¯å¢ƒè¦æ±‚

- Python 3.9+
- Node.js 16+
- DashScope API Key (é˜¿é‡Œäº‘)

## å¿«é€Ÿå¯åŠ¨

### 1. æ•°æ®é¢„å¤„ç† (å¯é€‰)
çŸ¥è¯†åº“å·²ç”Ÿæˆï¼Œå¦‚éœ€é‡æ–°å¤„ç†ï¼š
```bash
python scripts/preprocess.py
```

### 2. å¯åŠ¨åç«¯
```bash
cd server
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt

export DASHSCOPE_API_KEY="sk-..."
uvicorn main:app --reload --port 8000
```

### 3. å¯åŠ¨å‰ç«¯
```bash
cd client
npm install
npm run dev
```
è®¿é—® http://localhost:5173

## API æ¥å£

| è·¯ç”± | æ–¹æ³• | åŠŸèƒ½ |
|------|------|------|
| `/` | GET | å¥åº·æ£€æŸ¥ |
| `/knowledge` | GET | è·å–çŸ¥è¯†åº“ |
| `/chat` | POST | å¯¹è¯å¤„ç† |
| `/logs` | GET | æŸ¥è¯¢å†å²æ—¥å¿— |

### å¯¹è¯è¯·æ±‚ç¤ºä¾‹
```bash
curl -X POST http://localhost:8000/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "æ‰“å¼€ç©ºè°ƒ", "history": []}'
```

### å“åº”æ ¼å¼
```json
{
  "reply": "å¥½çš„ï¼Œå·²ä¸ºæ‚¨æ‰“å¼€ç©ºè°ƒ",
  "action": {"action": "AC_ON"},
  "trace": {"latency_ms": 1200, "token_usage": {...}},
  "log_id": 1
}
```

## æ•°æ®åº“ç»“æ„ (ChatLog)

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `user_input` | Text | ç”¨æˆ·è¾“å…¥ |
| `intent_detected` | String | æ£€æµ‹åˆ°çš„æ„å›¾ |
| `full_prompt` | Text | å®Œæ•´ Prompt |
| `raw_response` | Text | LLM åŸå§‹å“åº” |
| `parsed_action` | JSON | è§£æåçš„åŠ¨ä½œ |
| `latency_ms` | Integer | å»¶è¿Ÿ (æ¯«ç§’) |
| `token_usage` | JSON | Token ç”¨é‡ |

## çŸ¥è¯†åº“å†…å®¹

### è½¦è¾†æ§åˆ¶è§„åˆ™ (5 æ¡)
- ç¡¬ä»¶ä¸æ”¯æŒæ—¶å›å¤ "æš‚ä¸æ”¯æŒæ­¤æŠ€èƒ½"
- æ”¯æŒå„ä½ç½®ç‹¬ç«‹æ§åˆ¶ (ä¸»é©¾/å‰¯é©¾/å‰æ’/åæ’)
- è½¦è¾†æœªå¯åŠ¨æ—¶æ‹’ç»ç©ºè°ƒç›¸å…³å‘½ä»¤

### æ”¯æŒçš„åŠŸèƒ½é¢†åŸŸ

```mermaid
mindmap
  root((ğŸš— Vehicle))
    ğŸŒ¡ï¸ ç©ºè°ƒæ§åˆ¶
      æ‰“å¼€/å…³é—­ç©ºè°ƒ
      æ¸©åº¦è°ƒèŠ‚
      é£é‡è®¾ç½®
      åˆ¶å†·/åˆ¶çƒ­
    ğŸ’¨ é£å‘æ§åˆ¶
      å¹è¶³/å¹é¢
      æ¨¡å¼åˆ‡æ¢
    â„ï¸ é™¤éœœé™¤é›¾
      å‰åé™¤éœœ
      æœ€å¤§é™¤éœœ
    ğŸ’º åº§æ¤…æ§åˆ¶
      åŠ çƒ­
      é€šé£
      æŒ‰æ‘©
    ğŸªŸ è½¦çª—å¤©çª—
      å¼€å…³æ§åˆ¶
      é”å®šè§£é”
    ğŸ’¡ ç¯å…‰æ§åˆ¶
      è¿‘å…‰ç¯/è¿œå…‰ç¯
      æ°›å›´ç¯
```

## å‰ç«¯åŠŸèƒ½

1. **å¯¹è¯ç•Œé¢**: å®æ—¶èŠå¤© + å¿«æ·æŒ‡ä»¤
2. **æ€ç»´é“¾æŸ¥çœ‹**: Prompt / Token / å»¶è¿Ÿ / cURL
3. **çŸ¥è¯†åº“å±•ç¤º**: è§„åˆ™åˆ—è¡¨ + æ„å›¾è¡¨æ ¼

## é¡¹ç›®äº®ç‚¹

- âœ… å®Œæ•´çš„è°ƒè¯•å·¥å…·é“¾ (æ€ç»´é“¾å¯è§†åŒ–)
- âœ… ç»“æ„åŒ– JSON è¾“å‡ºï¼Œä¾¿äºåç»­å¤„ç†
- âœ… å¤šä½ç½®æ”¯æŒ (ä¸»é©¾/å‰¯é©¾/å‰åæ’)
- âœ… çŸ¥è¯†åº“é©±åŠ¨ï¼Œä» Excel è‡ªåŠ¨ç”Ÿæˆ
- âœ… ä¿ç•™æœ€è¿‘ 5 è½®å¯¹è¯ä¸Šä¸‹æ–‡
